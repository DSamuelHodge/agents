# Digital Twin MVP - Cloudflare Configuration
name = "digital-twin-mvp"
main = "worker/src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Account configuration (use your Cloudflare account)
account_id = "6c2dbbe47de58a74542ad9a5d9dd5b2b"

# Workers configuration
workers_dev = true
route = ""

# Build configuration (handled by wrangler with module entry)

# Durable Object for workflow coordination (Agents SDK)
[[durable_objects.bindings]]
name = "WORKFLOW_AGENT"
class_name = "WorkflowAgentSql"

# Worker Loader for experimental codemode execution (global)
[[unsafe.bindings]]
name = "LOADER"
type = "service"

# Migrations for Durable Objects (Agents SDK pattern)
[[migrations]]
tag = "v1"
new_classes = ["WorkflowCoordinator"]

[[migrations]]
tag = "v2"
new_classes = ["WorkflowAgent"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["WorkflowAgentSql"]

# Environment variables (non-sensitive only)
[vars]
ENVIRONMENT = "production"
REFLECTION_ENABLED = "true"
MAX_REQUEST_SIZE = "262144"  # 256 KB
MAX_OUTPUT_SIZE = "32768"    # 32 KB per step
GITHUB_OWNER = "DSamuelHodge"  # GitHub username/org for generated projects repo
GITHUB_REPO = "generated-projects"  # GitHub repo name for generated code artifacts

# Secrets (NEVER commit actual values - use wrangler secret put)
# Set secrets via: 
#   wrangler secret put GEMINI_API_KEY
#   wrangler secret put GITHUB_TOKEN
# GEMINI_API_KEY = "<set via wrangler secret put>"
# GITHUB_TOKEN = "<set via wrangler secret put>"
# Get free key from: https://aistudio.google.com/app/apikey
# Get GitHub token from: https://github.com/settings/tokens (needs repo, workflow permissions)

# Security: All secrets must be set via wrangler CLI:
# - wrangler secret put GEMINI_API_KEY
# - wrangler secret put GITHUB_TOKEN
# Verify secrets are not in client bundles: npm run build && grep -r "GEMINI\|GITHUB_TOKEN" dist/

# Optional bindings (commented out - uncomment if needed)
# [[d1_databases]]
# binding = "DB"
# database_name = "digital-twin-db"
# database_id = "your-d1-database-id"

# [[r2_buckets]]
# binding = "ARTIFACTS"
# bucket_name = "digital-twin-artifacts"

# [[vectorize]]
# binding = "VECTORIZE"
# index_name = "agent-outputs"

# KV Namespace (optional - for caching)
[[kv_namespaces]]
binding = "CACHE"
id = "your-kv-namespace-id"

# Analytics Engine (optional - for monitoring)
[[analytics_engine_datasets]]
binding = "ANALYTICS"

# Rate Limiting (optional)
[limits]
cpu_ms = 50000  # 50 seconds per request (generous for long agent workflows)

# Development configuration
[env.development]
name = "digital-twin-dev"
vars = { ENVIRONMENT = "development" }

# Staging configuration
[env.staging]
name = "digital-twin-staging"
vars = { ENVIRONMENT = "staging" }

# Production configuration  
[env.production]
name = "digital-twin-prod"
vars = { ENVIRONMENT = "production", MAX_AGENTS = "500" }

# Observability
[observability]
enabled = true

# Custom domains (optional)
# [[routes]]
# pattern = "api.digital-twin.com/*"
# custom_domain = true


# Asset configuration (for frontend)
[assets]
directory = "./public"
binding = "ASSETS"